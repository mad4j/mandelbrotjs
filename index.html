
<!DOCTYPE html>
<html lang="it">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" id="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
		<meta name="theme-color" content="#000000">
		<title>Mandelbrot Explorer</title>
		<style>
			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
				touch-action: none;
				user-select: none;
				-webkit-user-select: none;
			}

			body {
				font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
				background: #000;
				overflow: hidden;
				position: fixed;
				width: 100%;
				height: 100%;
				display: flex;
				align-items: center;
				justify-content: center;
			}

			canvas {
				display: block;
			}

			.info {
				position: absolute;
				bottom: 10px;
				left: 50%;
				transform: translateX(-50%);
				color: rgba(255, 255, 255, 0.8);
				font-size: 11px;
				font-weight: 300;
				letter-spacing: 0.5px;
				pointer-events: none;
				z-index: 10;
				background: rgba(0, 0, 0, 0.5);
				padding: 8px 12px;
				border-radius: 4px;
				backdrop-filter: blur(10px);
				-webkit-backdrop-filter: blur(10px);
				transition: opacity 0.3s ease;
			}

			.info.hidden {
				opacity: 0;
			}

			.reset-btn {
				position: absolute;
				bottom: 20px;
				right: 20px;
				width: 40px;
				height: 40px;
				background: rgba(255, 255, 255, 0.1);
				backdrop-filter: blur(10px);
				-webkit-backdrop-filter: blur(10px);
				border: 1px solid rgba(255, 255, 255, 0.2);
				border-radius: 50%;
				display: flex;
				align-items: center;
				justify-content: center;
				color: rgba(255, 255, 255, 0.8);
				font-size: 18px;
				cursor: pointer;
				transition: all 0.3s ease;
				z-index: 10;
			}

			.reset-btn:active {
				transform: scale(0.9);
				background: rgba(255, 255, 255, 0.2);
			}

			.gesture-hint {
				position: absolute;
				top: 50%;
				left: 50%;
				transform: translate(-50%, -50%);
				color: rgba(255, 255, 255, 0.4);
				font-size: 14px;
				text-align: center;
				pointer-events: none;
				animation: fadeOut 3s ease-out forwards;
				animation-delay: 1s;
			}

			@keyframes fadeOut {
				to { opacity: 0; }
			}
		</style>
</head>
<body>
	<div class="info" id="info">
		<div>ZOOM: <span id="zoom">1.0×</span></div>
		<div>ITER: <span id="iterations">286</span></div>
		<div>TIME: <span id="renderTime">0.0s</span></div>
		<div>ENGINE: <span id="computeEngine">JS</span></div>
	</div>
	
	<div class="gesture-hint">
		Pinch to zoom • Drag to pan • Double tap to zoom
	</div>

	<div class="reset-btn" id="resetBtn">↺</div>

	<canvas id="mandelCanvas" onwheel="wheelMoved(event);">Sorry, your browser does not have HTML canvas support.</canvas>
	
	<!-- Hidden elements to prevent errors in mandel-workers.js -->
	<div id="logText" style="display: none;"></div>
	<div id="workingText" style="display: none;"></div>
	<div id="zoomText" style="display: none;"></div>
	<div id="mandelText" style="display: none;"></div>
	<div id="currentPalette" style="display: none;"></div>
	<input id="iterSlider" type="range" style="display: none;" value="286">
	<input id="itersInput" type="number" style="display: none;" value="286">
	<input id="xPosText" type="text" style="display: none;">
	<input id="yPosText" type="text" style="display: none;">
	<div id="coordSource" style="display: none;"></div>
	<div id="coordSource2" style="display: none;"></div>
	<div id="cycle" style="display: none;"></div>
	<div id="nextPalette" style="display: none;"></div>
	<div id="prevPalette" style="display: none;"></div>
	<div id="aboutClose" style="display: none;"></div>
	<div id="linkClose" style="display: none;"></div>
	<div id="posterClose" style="display: none;"></div>
	<div id="aboutBox" style="display: none;"></div>
	<div id="linkDialog" style="display: none;"></div>
	<div id="posterDialog" style="display: none;"></div>
	<div id="posterDialogBody" style="display: none;"></div>
	<div id="permalinkURL" style="display: none;"></div>
	<div id="permalinkAnchor" style="display: none;"></div>
	<div id="aboutBoxContent" style="display: none;"></div>
	<div id="showInstructionsBtn" style="display: none;"></div>
	<div id="showMathematicsBtn" style="display: none;"></div>
	<div id="showFractalsBtn" style="display: none;"></div>
	<select id="jumpTo" style="display: none;"><option value="choose">Jump To...</option></select>
	<input type="checkbox" id="showAxes" style="display: none;">
	<input type="checkbox" id="smooth" style="display: none;">

<script src="mandel-workers.js"></script>
<script>
	// Stub functions for missing UI elements to prevent errors
	function changeIters() {}
	function toggleAxes() { showAxes = 0; }
	function toggleSmooth() { smooth = 1; }
	function showAboutBox() {}
	function jumpTo() {}
	function newCoords() {}
	function saveState() {}
	function makePoster() {}
	function incrPalette() { if (typeof nextPaletteClickHandler === 'function') nextPaletteClickHandler(); }
	function decrPalette() { if (typeof prevPaletteClickHandler === 'function') prevPaletteClickHandler(); }
	function toggleRotatePalette() { if (typeof cycleClickHandler === 'function') cycleClickHandler(); }

	// Override variables that reference missing DOM elements
	if (typeof logText === 'undefined' || !logText) logText = { innerHTML: '' };
	if (typeof cycleText === 'undefined' || !cycleText) cycleText = { innerHTML: 'Animate' };
	if (typeof workingText === 'undefined' || !workingText) workingText = { innerHTML: '', style: { visibility: 'hidden' } };
	if (typeof zoomText === 'undefined' || !zoomText) zoomText = { innerHTML: '' };
	if (typeof iterSlider === 'undefined' || !iterSlider) iterSlider = { value: 286 };

	// Global variable to track actual WASM usage reported by workers
	let actualWasmUsage = false;
	let wasmUsageDetected = false;
	if (typeof mandelText === 'undefined' || !mandelText) mandelText = { innerHTML: '' };
	if (typeof itersInput === 'undefined' || !itersInput) itersInput = { value: 286 };
	if (typeof xPosText === 'undefined' || !xPosText) xPosText = { value: '', reportValidity: () => true };
	if (typeof yPosText === 'undefined' || !yPosText) yPosText = { value: '', reportValidity: () => true };
	if (typeof paletteText === 'undefined' || !paletteText) paletteText = { innerHTML: 'Original' };
	if (typeof viewportTag === 'undefined' || !viewportTag) viewportTag = { setAttribute: () => {} };

	// Disable Julia set display
	showAxes = 0;
	smooth = 1;

	// Responsive canvas setup
	function resizeCanvas() {
		const canvas = document.getElementById('mandelCanvas');
		
		// Make canvas square using the minimum dimension
		const size = Math.min(window.innerWidth, window.innerHeight);
		
		// Set display size (css pixels)
		canvas.style.width = size + 'px';
		canvas.style.height = size + 'px';
		
		// Set internal size to match mandel-workers.js expectations but with square aspect ratio
		// Use coarseWidth (600) for both dimensions to maintain square aspect
		canvas.width = 600;  // coarseWidth from mandel-workers.js (now square)
		canvas.height = 600; // Make it square
	}

	// Update info display
	function updateInfoDisplay() {
		const zoomText = zoom > 1000 ? zoom.toExponential(2) : zoom.toFixed(1) + '×';
		document.getElementById('zoom').textContent = zoomText;
		document.getElementById('iterations').textContent = iterations;
		
		// Update compute engine information based on actual WASM usage
		let engineText;
		if (wasmUsageDetected) {
			engineText = actualWasmUsage ? 'WASM' : 'JS (fallback)';
		} else {
			// Fallback to old method if no usage detected yet
			engineText = (typeof COMPUTE_WORKER_SCRIPT !== 'undefined' && COMPUTE_WORKER_SCRIPT.includes('wasm')) ? 'WASM (loading...)' : 'JS';
		}
		document.getElementById('computeEngine').textContent = engineText;
	}

	// Show info panel after render completion
	function showInfoAfterRender(renderTimeMs) {
		updateInfoDisplay();
		const timeText = (renderTimeMs / 1000).toFixed(1) + 's';
		// Include worker count in the time display as requested: 'Time: Ts (N cores)'
		const workerCount = typeof workers !== 'undefined' ? workers : 4;
		document.getElementById('renderTime').textContent = timeText + ' (' + workerCount + ' cores)';
		showInfo();
	}

	// Hide info panel (called when zoom/movement starts)
	function hideInfo() {
		clearTimeout(infoTimeout);
		document.getElementById('info').classList.add('hidden');
	}

	// Reset functionality
	function resetView() {
		// Reset to home position like the original
		destX = -1.34228;
		destY = 0.0;
		destZoom = 300;
		// Use autotuned iterations based on zoom level
		if (typeof calculateAdaptiveIterations === 'function') {
			destIters = calculateAdaptiveIterations(300);
		} else {
			destIters = 200;
		}
		travelling = 2;
		startRender(1, 1);
	}

	// Initialize responsive canvas
	window.addEventListener('resize', resizeCanvas);
	document.getElementById('resetBtn').addEventListener('click', resetView);
	
	// Auto-hide info display
	let infoTimeout;
	function showInfo() {
		document.getElementById('info').classList.remove('hidden');
		clearTimeout(infoTimeout);
		infoTimeout = setTimeout(() => {
			document.getElementById('info').classList.add('hidden');
		}, 5000);
	}

	// Show info on interaction - only for mouse, let mandel-workers.js handle touch
	document.getElementById('mandelCanvas').addEventListener('mousedown', showInfo);
	
	// Initial setup
	resizeCanvas();
	showInfo();
	
	// Trigger initial render
	if (typeof startRender === 'function') {
		startRender(1, 1);
	}

	// Override the original updateCoords to update our info display
	const originalUpdateCoords = window.updateCoords;
	if (typeof originalUpdateCoords === 'function') {
		window.updateCoords = function(x, y, source) {
			originalUpdateCoords(x, y, source);
			updateInfoDisplay();
		};
	} else {
		// Create a basic updateCoords if it doesn't exist
		window.updateCoords = function(x, y, source) {
			updateInfoDisplay();
		};
	}

	// Override onComputeEnded to track WASM usage
	window.addEventListener('load', function() {
		// Wait for mandel-workers.js to load, then override the onComputeEnded function
		setTimeout(function() {
			if (typeof onComputeEnded !== 'undefined') {
				const originalOnComputeEnded = onComputeEnded;
				window.onComputeEnded = function(e) {
					// Track WASM usage if reported by worker
					if (e.data.hasOwnProperty('usedWasm')) {
						wasmUsageDetected = true;
						actualWasmUsage = e.data.usedWasm;
						if (e.data.usedWasm) {
							console.log('Using WebAssembly for computation');
						} else {
							console.log('Using JavaScript fallback for computation');
						}
					}
					// Call original function
					return originalOnComputeEnded(e);
				};
			}
			
			// Also override the oneshot compute function
			if (typeof onOneShotComputeEnded !== 'undefined') {
				const originalOnOneShotComputeEnded = onOneShotComputeEnded;
				window.onOneShotComputeEnded = function(e) {
					if (e.data.hasOwnProperty('usedWasm')) {
						wasmUsageDetected = true;
						actualWasmUsage = e.data.usedWasm;
					}
					return originalOnOneShotComputeEnded(e);
				};
			}
		}, 100);
	});
</script>
</body>
</html>
